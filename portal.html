<!doctype html>
<html lang="pt-BR">
  <!-- Portal do Festival de Teatro do Recife • Catálogo -->
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Festival de Teatro do Recife • Catálogo</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }
      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000") center/cover no-repeat;
        color: #fff;
        padding: 3rem 0 2.25rem;
      }
      header .lead {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        line-height: 1.65;
        max-width: 100%;
      }
      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.14);
      }
      .section-title {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-strong);
      }
      .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }
      .card {
        border-radius: 4px;
        overflow: hidden;
      }
      .card-programa {
        border: 1px solid rgba(0, 83, 164, 0.08);
        border-radius: 4px;
        background: var(--surface-strong);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
      }
      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 83, 164, 0.08);
        background: linear-gradient(180deg, #fff 0%, #f5f8fc 100%);
        padding: 1.25rem 1.25rem 1rem;
      }
      .muted {
        color: var(--text-muted);
      }
      .actions-cell {
        white-space: normal;
        vertical-align: middle;
      }
      .actions-cell .actions-wrapper {
        display: inline-flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
      }
      .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        min-width: 2.5rem;
        min-height: 2.5rem;
        line-height: 1;
      }
      .btn-icon span[aria-hidden='true'] {
        font-size: 1.05rem;
      }
      .prefs-responsive .table > :not(caption) > * > * {
        padding: 0.85rem 1.1rem;
        vertical-align: middle;
      }
      .uppercase {
        text-transform: uppercase;
      }
      .small-note {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .table thead th {
        white-space: nowrap;
      }
      .table-fixed {
        table-layout: fixed;
      }
      .modal-alert-title {
        color: #dc3545;
      }
      .alert-list {
        padding-left: 1.1rem;
      }
      .modal-branding {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .modal-branding img {
        height: 48px;
        width: auto;
      }
      .resumo-card {
        border: 1px solid rgba(0, 83, 164, 0.12);
        border-radius: 12px;
        background: linear-gradient(180deg, #ffffff 0%, rgba(244, 247, 251, 0.8) 100%);
        box-shadow: 0 18px 46px rgba(0, 35, 79, 0.15);
      }
      .resumo-card .meta-label {
        display: block;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
      }
      .resumo-card .meta-value {
        font-weight: 600;
        font-size: 1.05rem;
        color: var(--text-strong);
      }
      .resumo-table thead {
        background: #0053a4;
        color: #fff;
      }
      .resumo-table th {
        font-weight: 600;
      }
      .solicitacao-box {
        display: inline-flex;
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
        padding: 0.65rem 1.65rem 0.75rem;
        border-radius: 18px;
        background: linear-gradient(135deg, #eaf1ff 0%, #d5e2ff 100%);
        border: 1px solid rgba(0, 83, 164, 0.15);
        box-shadow: 0 18px 32px rgba(21, 56, 128, 0.12);
        min-width: 260px;
      }
      .solicitacao-box .solicitacao-label {
        font-size: 0.75rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(15, 44, 102, 0.7);
        font-weight: 700;
      }
      .solicitacao-box .solicitacao-value {
        font-size: 1.9rem;
        font-weight: 700;
        color: #0f2c66;
        word-break: break-word;
        text-align: right;
        align-self: stretch;
        line-height: 1.05;
      }
      #printComprovante {
        background: #fff;
        border-radius: 12px;
        border: 1px solid rgba(0, 83, 164, 0.12);
        box-shadow: 0 24px 80px rgba(0, 37, 84, 0.18);
        overflow: hidden;
        max-width: 960px;
        margin: 0 auto;
        color: var(--text-strong);
      }
      #printComprovante .receipt-header {
        background: linear-gradient(135deg, #0053a4, #003a73);
        color: #fff;
        display: flex;
        justify-content: space-between;
        gap: 2rem;
        padding: 1.75rem 2rem;
        align-items: flex-start;
      }
      #printComprovante .receipt-header .brand {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
      }
      #printComprovante .receipt-header .brand img {
        height: 60px;
        width: auto;
      }
      #printComprovante .receipt-header .brand strong {
        display: block;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }
      #printComprovante .receipt-header .brand span {
        display: block;
        font-size: 0.9rem;
        opacity: 0.85;
      }
      #printComprovante .receipt-header .protocol {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        text-align: right;
        min-width: 180px;
      }
      #printComprovante .receipt-header .protocol .label {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.85;
      }
      #printComprovante .receipt-header .protocol .value {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: 0.04em;
      }
      #printComprovante .receipt-body {
        padding: 2rem;
      }
      #printComprovante .receipt-body h5,
      #printComprovante .receipt-body h4 {
        font-weight: 700;
        color: #003a73;
      }
      #printComprovante .receipt-intro p {
        margin-bottom: 0;
        color: var(--text-muted);
      }
      #printComprovante .receipt-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
      }
      #printComprovante .receipt-info-item {
        background: rgba(0, 83, 164, 0.06);
        border-radius: 10px;
        padding: 1rem 1.25rem;
      }
      #printComprovante .receipt-info-item .info-label {
        font-size: 0.8rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #003a73;
        font-weight: 600;
      }
      #printComprovante .receipt-info-item .info-value {
        display: block;
        margin-top: 0.35rem;
        font-size: 1rem;
        font-weight: 600;
      }
      #printComprovante .receipt-table {
        width: 100%;
        border-collapse: collapse;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
      }
      #printComprovante .receipt-table thead {
        background: #0053a4;
        color: #fff;
      }
      #printComprovante .receipt-table th,
      #printComprovante .receipt-table td {
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(0, 83, 164, 0.12);
      }
      #printComprovante .receipt-table tbody tr:nth-child(even) {
        background: rgba(0, 83, 164, 0.03);
      }
      #printComprovante .receipt-footer {
        margin-top: 2rem;
        font-size: 0.85rem;
        color: var(--text-muted);
        text-align: right;
      }

      /* ====== Ajustes específicos do catálogo ====== */
      .catalog-toolbar .form-select,
      .catalog-toolbar .form-control {
        border-color: var(--border-color);
      }
      .catalog-grid .card.play-card {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .play-card .card-body {
        display: flex;
        flex-direction: column;
      }
      .sinopse-clamp {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .badge-age {
        background: #e9f4ff;
        color: var(--brand-secondary);
        border: 1px solid rgba(0,83,164,.18);
        font-weight: 700;
      }
      .btn-fav[aria-pressed="true"] {
        border-color: #ffc107 !important;
      }

      @media print {
        body * {
          visibility: hidden !important;
        }
        #printComprovante,
        #printComprovante * {
          visibility: visible !important;
        }
        #printComprovante {
          position: absolute;
          inset: 0;
          margin: 0 auto;
          box-shadow: none;
        }
      }
      @media (max-width: 768px) {
        header.site-header {
          padding: 2.25rem 0 1.75rem;
        }
        .badge-open {
          width: 100%;
          justify-content: center;
        }
      }
      @media (max-width: 576px) {
        .catalog-toolbar .row > * + * {
          margin-top: .5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <header class="site-header">
      <div class="container">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
          <div>
            <h1 class="display-5 fw-bold mb-2">Festival de Teatro do Recife</h1>
            <p class="lead mb-0">Programação oficial da Secretaria de Cultura do Recife • Explore as peças, confira sinopses e escolha seu teatro.</p>
          </div>
          <div class="text-md-end">
            <span class="badge-open">
              <span aria-hidden="true">🎭</span>
              Programação aberta
            </span>
            <div class="mt-2">
              <button class="btn btn-light btn-sm" type="button"
                data-bs-toggle="offcanvas" data-bs-target="#offcanvasFav"
                aria-controls="offcanvasFav">
                Favoritos <span class="badge text-bg-primary align-middle ms-1" id="favCount">0</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- FILTROS -->
    <section class="py-4">
      <div class="container">
        <div class="card card-programa">
          <div class="card-header">
            <div class="section-title mb-0">Filtrar programação</div>
          </div>
          <div class="card-body catalog-toolbar">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-6 col-lg-5">
                <label class="form-label small fw-semibold text-uppercase text-muted">Busca</label>
                <input type="search" id="q" class="form-control" placeholder="Digite nome da peça, teatro ou trecho da sinopse…" />
              </div>
              <div class="col-6 col-md-3 col-lg-3">
                <label class="form-label small fw-semibold text-uppercase text-muted">Teatro</label>
                <select id="fTeatro" class="form-select">
                  <option value="">Todos os teatros</option>
                </select>
              </div>
              <div class="col-6 col-md-3 col-lg-2">
                <label class="form-label small fw-semibold text-uppercase text-muted">Classificação</label>
                <select id="fClass" class="form-select">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="col-12 col-lg-2 d-grid">
                <button id="btnLimpar" class="btn btn-outline-secondary">Limpar filtros</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CATÁLOGO -->
    <section class="py-3">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="section-title mb-0">Catálogo de peças</div>
          <small class="text-muted" id="resultInfo">Exibindo 0 de 0</small>
        </div>
        <div id="grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3 catalog-grid">
          <!-- cards renderizados via JS -->
        </div>
      </div>
    </section>

    <!-- MODAL: DETALHES -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalTitulo" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="modalTitulo">Título da peça</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <div class="ratio ratio-2x3 bg-light">
                  <img id="modalPoster" src="" alt="Pôster da peça" class="w-100 h-100 object-fit-cover rounded">
                </div>
              </div>
              <div class="col-12 col-md-7">
                <div class="mb-2">
                  <span class="badge badge-age" id="modalClass">Livre</span>
                </div>
                <p class="mb-2 small text-uppercase text-muted fw-semibold">Teatro</p>
                <p class="fw-semibold" id="modalTeatro">—</p>
                <p class="mb-0" id="modalSinopse">—</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="modalFavBtn" type="button" class="btn btn-outline-warning">Favoritar</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- OFFCANVAS: FAVORITOS -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFav" aria-labelledby="offcanvasFavLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasFavLabel">Favoritos</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>
      <div class="offcanvas-body">
        <div id="favList" class="list-group">
          <!-- itens de favoritos via JS -->
        </div>
        <div class="mt-3 d-flex gap-2">
          <button id="btnExportFav" class="btn btn-outline-primary btn-sm">Exportar IDs</button>
          <button id="btnClearFav" class="btn btn-outline-danger btn-sm">Limpar favoritos</button>
        </div>
      </div>
    </div>

    <!-- RODAPÉ -->
    <footer class="py-5">
      <div class="container text-center small text-muted">
        Secretaria de Cultura do Recife • Prefeitura do Recife
      </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ====== Dataset de exemplo (8–12 itens) ======
      const IMG = "https://assets.bileto.sympla.com.br/eventmanager/production/gr8ca4bpfsukhu930gu1s4e23j052pl35o0bgji1o6ebt6vdho17om62mobpdh4svlfspuad73stmbc56e252cocmst0q78bd2mr4g.webp";
      const pecas = [
        {
          id: "aurora-nas-esquinas",
          nome: "Aurora nas Esquinas",
          classificacao: "12+",
          teatro: "Teatro Santa Isabel",
          sinopse: "Uma viagem poética pelas ruas do Recife, onde memórias se cruzam com o cotidiano e cada esquina revela afetos e segredos que insistem em permanecer vivos.",
          poster: IMG
        },
        {
          id: "maresia",
          nome: "Maresia",
          classificacao: "Livre",
          teatro: "Teatro Apolo",
          sinopse: "Entre calmarias e tempestades, uma família ribeirinha enfrenta mudanças climáticas e afetivas, assinando pactos silenciosos com o vento e a maré.",
          poster: IMG
        },
        {
          id: "o-auto-do-frevo",
          nome: "O Auto do Frevo",
          classificacao: "10+",
          teatro: "Paço do Frevo",
          sinopse: "Musical festivo que mistura frevo, teatro e narrativa popular para contar a saga de um estandarte que ganha vida e sai em busca da sua orquestra.",
          poster: IMG
        },
        {
          id: "paredes-que-falam",
          nome: "Paredes que Falam",
          classificacao: "14+",
          teatro: "Teatro Luiz Mendonça",
          sinopse: "Em um edifício histórico prestes a ruir, moradores compartilham lembranças e disputas, enquanto o passado sussurra pelos azulejos e pelas portas entreabertas.",
          poster: IMG
        },
        {
          id: "cartas-para-clarice",
          nome: "Cartas para Clarice",
          classificacao: "16+",
          teatro: "Teatro Santa Isabel",
          sinopse: "Fragmentos de cartas nunca enviadas se transformam em cena, explorando silêncio, identidade e a força das pequenas escolhas que mudam destinos.",
          poster: IMG
        },
        {
          id: "cidade-som",
          nome: "Cidade-Som",
          classificacao: "Livre",
          teatro: "Parque Dona Lindu",
          sinopse: "Instalação cênica com música ao vivo em que o público percorre paisagens sonoras e descobre personagens escondidos no ruído da cidade.",
          poster: IMG
        },
        {
          id: "o-ultimo-fio",
          nome: "O Último Fio",
          classificacao: "18+",
          teatro: "Teatro Apolo",
          sinopse: "Dois irmãos costuram lembranças para não esquecer o que o tempo tenta rasgar. Um drama íntimo sobre família, perda e possibilidades de recomeço.",
          poster: IMG
        },
        {
          id: "couraça",
          nome: "Couraça",
          classificacao: "14+",
          teatro: "Teatro Luiz Mendonça",
          sinopse: "Corpos que dançam e falas entrecortadas constroem um mosaico sobre proteção e vulnerabilidade em tempos de urgência.",
          poster: IMG
        },
        {
          id: "menina-e-o-vento",
          nome: "A Menina e o Vento",
          classificacao: "10+",
          teatro: "Paço do Frevo",
          sinopse: "A amizade improvável entre uma criança curiosa e um vento brincalhão desafia regras e apresenta uma nova forma de habitar o mundo.",
          poster: IMG
        },
        {
          id: "rio-subterraneo",
          nome: "Rio Subterrâneo",
          classificacao: "12+",
          teatro: "Parque Dona Lindu",
          sinopse: "Narrativa que revela um Recife oculto sob as águas, onde memórias afundadas retornam para guiar um grupo em busca de pertencimento.",
          poster: IMG
        },
        {
          id: "todas-as-portas",
          nome: "Todas as Portas",
          classificacao: "16+",
          teatro: "Teatro Santa Isabel",
          sinopse: "Em um jogo de escolhas, personagens atravessam portas que levam a futuros possíveis, desafiando o público a decidir quem permanece em cena.",
          poster: IMG
        },
        {
          id: "acendimento",
          nome: "Acendimento",
          classificacao: "Livre",
          teatro: "Teatro Apolo",
          sinopse: "Espetáculo luminoso sobre esperanças cotidianas, acendendo histórias miúdas que brilham quando a cidade adormece.",
          poster: IMG
        }
      ];

      // ====== Estado / utilidades ======
      const $ = (sel, el = document) => el.querySelector(sel);
      const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
      const KEY_FAV = "ftr_favs";

      const elGrid = $("#grid");
      const elResultInfo = $("#resultInfo");
      const elQ = $("#q");
      const elFTeatro = $("#fTeatro");
      const elFClass = $("#fClass");
      const elBtnLimpar = $("#btnLimpar");
      const elFavCount = $("#favCount");
      const offcanvasFav = $("#offcanvasFav");
      const elFavList = $("#favList");
      const elBtnExportFav = $("#btnExportFav");
      const elBtnClearFav = $("#btnClearFav");

      const modal = new bootstrap.Modal($("#modalDetalhes"));
      const modalEl = $("#modalDetalhes");
      const mTitle = $("#modalTitulo");
      const mPoster = $("#modalPoster");
      const mClass = $("#modalClass");
      const mTeatro = $("#modalTeatro");
      const mSinopse = $("#modalSinopse");
      const mFavBtn = $("#modalFavBtn");

      const getFavs = () => {
        try { return JSON.parse(localStorage.getItem(KEY_FAV) || "[]"); }
        catch { return []; }
      };
      const setFavs = (arr) => localStorage.setItem(KEY_FAV, JSON.stringify(arr));
      const isFav = (id) => getFavs().includes(id);
      const toggleFav = (id) => {
        const curr = getFavs();
        const idx = curr.indexOf(id);
        if (idx >= 0) curr.splice(idx, 1); else curr.push(id);
        setFavs(curr);
        updateFavCount();
        renderFavList();
        // também refletir nos botões dos cards
        $$(`button[data-fav="${id}"]`).forEach(btn => {
          const pressed = curr.includes(id);
          btn.setAttribute("aria-pressed", pressed ? "true" : "false");
          btn.classList.toggle("btn-outline-warning", !pressed);
          btn.classList.toggle("btn-warning", pressed);
          btn.innerHTML = pressed ? '★ Favorito' : '☆ Favoritar';
        });
        return curr.includes(id);
      };

      const updateFavCount = () => {
        elFavCount.textContent = getFavs().length;
      };

      const unique = (arr) => [...new Set(arr)].sort((a,b)=>a.localeCompare(b, 'pt-BR'));

      // ====== Renderização de filtros ======
      function renderFilters() {
        const teatros = unique(pecas.map(p => p.teatro));
        const classes = unique(pecas.map(p => p.classificacao));

        teatros.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t; opt.textContent = t;
          elFTeatro.appendChild(opt);
        });

        classes.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          elFClass.appendChild(opt);
        });
      }

      // ====== Card template ======
      function cardTemplate(p) {
        const favPressed = isFav(p.id);
        return `
          <div class="col">
            <div class="card play-card h-100">
              <div class="ratio ratio-2x3">
                <img src="${p.poster}" alt="Pôster da peça ${p.nome}" class="w-100 h-100 object-fit-cover">
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <h5 class="card-title fw-bold mb-1">${p.nome}</h5>
                  <span class="badge badge-age flex-shrink-0">${p.classificacao}</span>
                </div>
                <p class="small text-muted mb-1">${p.teatro}</p>
                <p class="sinopse-clamp mb-3">${p.sinopse}</p>
                <div class="mt-auto d-flex gap-2">
                  <button class="btn btn-primary btn-sm" data-details="${p.id}">Detalhes</button>
                  <button class="btn ${favPressed ? 'btn-warning' : 'btn-outline-warning'} btn-sm btn-fav"
                          data-fav="${p.id}" aria-pressed="${favPressed}">
                    ${favPressed ? '★ Favorito' : '☆ Favoritar'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // ====== Render grid ======
      function renderGrid(list) {
        elGrid.innerHTML = list.map(cardTemplate).join("");
        elResultInfo.textContent = `Exibindo ${list.length} de ${pecas.length}`;
        // Bind dos botões
        $$("button[data-details]").forEach(btn => {
          btn.addEventListener("click", () => openDetails(btn.getAttribute("data-details")));
        });
        $$("button[data-fav]").forEach(btn => {
          btn.addEventListener("click", () => toggleFav(btn.getAttribute("data-fav")));
        });
      }

      // ====== Filtro ======
      function applyFilters() {
        const q = elQ.value.trim().toLowerCase();
        const t = elFTeatro.value;
        const c = elFClass.value;

        const filtered = pecas.filter(p => {
          const textMatch = !q || [p.nome, p.teatro, p.sinopse].some(v => v.toLowerCase().includes(q));
          const teatroMatch = !t || p.teatro === t;
          const classMatch = !c || p.classificacao === c;
          return textMatch && teatroMatch && classMatch;
        });

        renderGrid(filtered);
      }

      function resetFilters() {
        elQ.value = "";
        elFTeatro.value = "";
        elFClass.value = "";
        renderGrid(pecas);
      }

      // ====== Detalhes (Modal) ======
      function openDetails(id) {
        const p = pecas.find(x => x.id === id);
        if (!p) return;
        mTitle.textContent = p.nome;
        mPoster.src = p.poster;
        mPoster.alt = `Pôster da peça ${p.nome}`;
        mClass.textContent = p.classificacao;
        mTeatro.textContent = p.teatro;
        mSinopse.textContent = p.sinopse;

        // Estado do botão favorito no modal
        const favNow = isFav(p.id);
        mFavBtn.dataset.id = p.id;
        reflectModalFav(favNow);

        modal.show();
      }

      function reflectModalFav(isPressed) {
        mFavBtn.classList.toggle("btn-outline-warning", !isPressed);
        mFavBtn.classList.toggle("btn-warning", isPressed);
        mFavBtn.textContent = isPressed ? "Remover dos favoritos" : "Favoritar";
        mFavBtn.setAttribute("aria-pressed", isPressed ? "true" : "false");
      }

      mFavBtn.addEventListener("click", () => {
        const id = mFavBtn.dataset.id;
        const nowFav = toggleFav(id);
        reflectModalFav(nowFav);
      });

      // ====== Favoritos (Offcanvas) ======
      function renderFavList() {
        const ids = getFavs();
        if (!ids.length) {
          elFavList.innerHTML = `<div class="text-center text-muted">Nenhuma peça favoritada ainda.</div>`;
          return;
        }
        const items = ids
          .map(id => pecas.find(p => p.id === id))
          .filter(Boolean)
          .map(p => `
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
              <div class="me-3">
                <div class="fw-semibold">${p.nome}</div>
                <small>${p.teatro} • <span class="badge badge-age">${p.classificacao}</span></small>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" data-jump="${p.id}" data-bs-dismiss="offcanvas">Abrir</button>
                <button class="btn btn-outline-danger" data-remove="${p.id}">Remover</button>
              </div>
            </a>
          `).join("");
        elFavList.innerHTML = items;

        // Bind remover/abrir
        $$("button[data-remove]", elFavList).forEach(btn => {
          btn.addEventListener("click", (ev) => {
            ev.preventDefault();
            toggleFav(btn.getAttribute("data-remove"));
          });
        });
        $$("button[data-jump]", elFavList).forEach(btn => {
          btn.addEventListener("click", (ev) => {
            ev.preventDefault();
            const id = btn.getAttribute("data-jump");
            // abrir modal direto da peça
            openDetails(id);
          });
        });
      }

      elBtnExportFav.addEventListener("click", () => {
        const ids = getFavs();
        if (!ids.length) return alert("Nenhum favorito para exportar.");
        navigator.clipboard.writeText(ids.join(", ")).then(() => {
          alert("IDs copiados para a área de transferência.");
        });
      });

      elBtnClearFav.addEventListener("click", () => {
        if (confirm("Limpar todos os favoritos?")) {
          setFavs([]);
          updateFavCount();
          renderFavList();
          renderGrid(pecas); // ressincroniza botões
        }
      });

      // Atualiza lista quando offcanvas abre (garante sincronização)
      offcanvasFav.addEventListener("show.bs.offcanvas", renderFavList);

      // ====== Eventos dos filtros ======
      [elQ, elFTeatro, elFClass].forEach(el => {
        el.addEventListener("input", applyFilters);
        el.addEventListener("change", applyFilters);
      });
      elBtnLimpar.addEventListener("click", resetFilters);

      // ====== Boot ======
      function init() {
        renderFilters();
        updateFavCount();
        renderGrid(pecas);
      }
      init();
    </script>
  </body>
</html>
